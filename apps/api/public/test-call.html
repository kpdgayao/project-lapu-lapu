<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cybermeds AI Voice Assistant - Demo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --primary: #970000;
      --primary-dark: #7a0000;
      --secondary: #444444;
      --gray-light: #f8f8f8;
      --gray-border: #e0e0e0;
      --white: #ffffff;
      --success: #28a745;
      --warning: #ffc107;
      --error: #dc3545;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--gray-light);
      min-height: 100vh;
      color: var(--secondary);
    }

    .header {
      background: var(--white);
      border-bottom: 3px solid var(--primary);
      padding: 1rem 2rem;
      text-align: center;
    }

    .header img {
      max-width: 280px;
      height: auto;
    }

    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    .demo-badge {
      display: inline-block;
      background: var(--primary);
      color: var(--white);
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 1rem;
    }

    .disclaimer {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 0.875rem 1rem;
      margin-bottom: 1rem;
      font-size: 0.8rem;
      color: #856404;
    }

    .disclaimer-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .rate-limit-info {
      background: #e8f4fd;
      border: 1px solid #bee5eb;
      border-radius: 6px;
      padding: 0.5rem 0.75rem;
      font-size: 0.75rem;
      color: #0c5460;
      margin-top: 0.75rem;
      text-align: center;
    }

    .card {
      background: var(--white);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      margin-bottom: 1rem;
    }

    .card-header {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #888;
      margin-bottom: 0.75rem;
    }

    select {
      width: 100%;
      padding: 0.875rem 1rem;
      border: 2px solid var(--gray-border);
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
      color: var(--secondary);
      background: var(--white);
      cursor: pointer;
      transition: border-color 0.2s;
    }

    select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .status {
      text-align: center;
      padding: 1rem;
      border-radius: 8px;
      font-weight: 500;
      margin-bottom: 1rem;
    }

    .status.idle {
      background: #f0f0f0;
      color: #666;
    }

    .status.connecting {
      background: #fff8e6;
      color: #856404;
    }

    .status.active {
      background: #e8f5e9;
      color: #2e7d32;
      animation: pulse 2s infinite;
    }

    .status.error {
      background: #ffebee;
      color: #c62828;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .call-btn {
      width: 100%;
      padding: 1rem 1.5rem;
      font-size: 1rem;
      font-weight: 600;
      font-family: inherit;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    #startCall {
      background: var(--primary);
      color: var(--white);
    }

    #startCall:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-1px);
    }

    #startCall:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    #endCall {
      background: var(--error);
      color: var(--white);
      display: none;
    }

    #endCall:hover {
      background: #b71c1c;
    }

    .icon {
      width: 20px;
      height: 20px;
    }

    #transcript {
      background: var(--gray-light);
      border: 1px solid var(--gray-border);
      border-radius: 8px;
      padding: 1rem;
      min-height: 120px;
      max-height: 250px;
      overflow-y: auto;
      font-size: 0.9rem;
      line-height: 1.7;
    }

    .transcript-placeholder {
      color: #999;
      font-style: italic;
      text-align: center;
      padding: 2rem 0;
    }

    .agent-msg {
      color: var(--primary);
      margin-bottom: 0.5rem;
      padding-left: 0.5rem;
      border-left: 2px solid var(--primary);
    }

    .user-msg {
      color: var(--secondary);
      margin-bottom: 0.5rem;
      padding-left: 0.5rem;
      border-left: 2px solid #888;
    }

    .test-phrases {
      background: #fef9f9;
      border: 1px solid #f5e0e0;
      border-radius: 8px;
      padding: 1rem 1.25rem;
    }

    .test-phrases h4 {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .test-phrases ul {
      margin: 0;
      padding-left: 1.25rem;
      font-size: 0.85rem;
      color: #666;
    }

    .test-phrases li {
      margin-bottom: 0.4rem;
    }

    .test-phrases li:last-child {
      margin-bottom: 0;
    }

    .footer {
      text-align: center;
      padding: 1.5rem;
      font-size: 0.75rem;
      color: #999;
    }

    .footer a {
      color: var(--primary);
      text-decoration: none;
    }

    .mic-hint {
      text-align: center;
      font-size: 0.8rem;
      color: #888;
      margin-top: 0.75rem;
    }
  </style>
</head>
<body>
  <header class="header">
    <img src="/cybermeds-logo.png" alt="Cybermeds - 24/7 Online Pharmacy">
  </header>

  <div class="container">
    <div style="text-align: center;">
      <span class="demo-badge">AI Voice Assistant Demo</span>
    </div>

    <div class="disclaimer">
      <div class="disclaimer-title">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        Proof of Concept - Testing Mode
      </div>
      This is a demonstration prototype. Voice recognition accuracy and responses are being evaluated.
      Not for production use. Calls are limited during testing.
      <div class="rate-limit-info" id="rateLimitInfo">Loading usage info...</div>
    </div>

    <div class="card">
      <div class="card-header">Voice Agent</div>
      <select id="agentSelect">
        <option value="">Loading...</option>
      </select>
    </div>

    <div class="card">
      <div id="status" class="status idle">Ready to start call</div>

      <button id="startCall" class="call-btn">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
        </svg>
        Start Call
      </button>

      <button id="endCall" class="call-btn">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
        End Call
      </button>

      <div class="mic-hint">Make sure your microphone is enabled</div>
    </div>

    <div class="card">
      <div class="card-header">Live Transcript</div>
      <div id="transcript">
        <div class="transcript-placeholder">Conversation will appear here...</div>
      </div>
    </div>

    <div class="test-phrases">
      <h4>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="16" x2="12" y2="12"></line>
          <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        Try These Sample Questions
      </h4>
      <ul>
        <li>"May Neurotain Plus po ba kayo?"</li>
        <li>"Ano po yung benefits ng Neuro8?"</li>
        <li>"How much is Ricoverin Plus?"</li>
        <li>"May Vas8 ba kayo for hypertension?"</li>
        <li>"Pwede ba mag-order ng Recox for arthritis?"</li>
        <li>"May delivery ba kayo nationwide?"</li>
      </ul>
    </div>
  </div>

  <footer class="footer">
    Powered by AI &bull; <a href="https://www.cybermeds.ph" target="_blank">www.cybermeds.ph</a>
  </footer>

  <!-- Retell Web SDK via ES module -->
  <script type="module">
    import { RetellWebClient } from 'https://esm.sh/retell-client-js-sdk@2.0.7';

    const agentSelect = document.getElementById('agentSelect');
    const startBtn = document.getElementById('startCall');
    const endBtn = document.getElementById('endCall');
    const statusDiv = document.getElementById('status');
    const transcriptDiv = document.getElementById('transcript');
    const rateLimitInfo = document.getElementById('rateLimitInfo');

    let retellWebClient = null;
    let isCallActive = false;

    async function loadRateLimitStatus() {
      try {
        const response = await fetch('/api/web-call/status');
        const data = await response.json();
        rateLimitInfo.textContent = `${data.dailyCallsRemaining} of ${data.dailyCallsLimit} demo calls remaining today`;
      } catch (error) {
        rateLimitInfo.textContent = 'Limited demo calls available';
      }
    }

    async function loadAgents() {
      try {
        const response = await fetch('/api/web-call/agents');
        const data = await response.json();

        if (data.success && data.agents.length > 0) {
          agentSelect.innerHTML = data.agents.map(agent =>
            `<option value="${agent.agent_id}">${agent.agent_name || 'Cybermeds Assistant'}</option>`
          ).join('');
        } else {
          agentSelect.innerHTML = '<option value="">No agents configured</option>';
        }
      } catch (error) {
        console.error('Failed to load agents:', error);
        agentSelect.innerHTML = '<option value="">Unable to load agents</option>';
      }
    }

    function setStatus(status, message) {
      statusDiv.className = `status ${status}`;
      statusDiv.textContent = message;
    }

    function clearTranscript() {
      transcriptDiv.innerHTML = '<div class="transcript-placeholder">Conversation will appear here...</div>';
    }

    function addTranscript(role, text) {
      const placeholder = transcriptDiv.querySelector('.transcript-placeholder');
      if (placeholder) {
        transcriptDiv.innerHTML = '';
      }

      const msgDiv = document.createElement('div');
      msgDiv.className = role === 'agent' ? 'agent-msg' : 'user-msg';
      msgDiv.textContent = text;
      transcriptDiv.appendChild(msgDiv);
      transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
    }

    async function startCall() {
      const agentId = agentSelect.value;
      if (!agentId) {
        alert('Please select a voice agent');
        return;
      }

      try {
        setStatus('connecting', 'Connecting...');
        startBtn.disabled = true;
        transcriptDiv.innerHTML = '<div class="transcript-placeholder">Connecting to assistant...</div>';

        const response = await fetch('/api/web-call', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ agent_id: agentId })
        });

        const data = await response.json();

        if (!data.success) {
          throw new Error(data.message || 'Failed to connect');
        }

        retellWebClient = new RetellWebClient();

        retellWebClient.on('call_started', () => {
          setStatus('active', 'Call active - speak now');
          startBtn.style.display = 'none';
          endBtn.style.display = 'flex';
          isCallActive = true;
          transcriptDiv.innerHTML = '';
        });

        retellWebClient.on('call_ended', () => {
          setStatus('idle', 'Call ended');
          startBtn.style.display = 'flex';
          startBtn.disabled = false;
          endBtn.style.display = 'none';
          isCallActive = false;
          loadRateLimitStatus(); // Refresh remaining calls
        });

        retellWebClient.on('update', (update) => {
          if (update.transcript) {
            transcriptDiv.innerHTML = '';
            update.transcript.forEach(entry => {
              addTranscript(entry.role, entry.content);
            });
          }
        });

        retellWebClient.on('error', (error) => {
          console.error('Call error:', error);
          setStatus('error', 'Connection error - please try again');
          startBtn.style.display = 'flex';
          startBtn.disabled = false;
          endBtn.style.display = 'none';
          isCallActive = false;
        });

        await retellWebClient.startCall({
          accessToken: data.access_token
        });

      } catch (error) {
        console.error('Failed to start call:', error);
        setStatus('error', 'Failed to connect');
        startBtn.disabled = false;
      }
    }

    function endCall() {
      if (retellWebClient && isCallActive) {
        retellWebClient.stopCall();
      }
    }

    startBtn.addEventListener('click', startCall);
    endBtn.addEventListener('click', endCall);

    // Load initial data
    loadAgents();
    loadRateLimitStatus();
  </script>
</body>
</html>
